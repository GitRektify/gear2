<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Gear2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <img src="https://planipets.com/images/logo.png" alt="">

    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>

    <button class="settings-button btn" onclick="toggleSettings()">⚙️ Settings</button>

    <div class="settings-panel" id="settingsPanel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Settings</h3>
            <div>
                <button class="btn" id="saveBtn" onclick="saveSelectedKV()" disabled>💾 Save</button>
                <button class="btn" onclick="cancelSettings()">❌ Cancel</button>
                <button class="btn" id="deleteBtn" onclick="deleteCurrentKey()">🗑️ Delete</button>
            </div>
        </div>

        <div style="display: flex; margin-top: 20px; gap: 20px;">
            <!-- Left: Key Select -->
            <div style="flex: 1;">
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="addNewKey()">➕ Add</button>
                <label for="keySelect"><strong>Key</strong></label><br>
                <select id="keySelect" onchange="onKeyChange()" style="width: 100%;"></select>
            </div>

            <!-- Right: Edit Fields -->
            <div style="flex: 3;">
                <label><strong>Key Name</strong></label>
                <input type="text" id="editKey" style="width: 100%; margin-bottom: 10px;" />

                <label><strong>Value</strong></label>
                <textarea id="editValue" rows="6" style="width: 100%;"></textarea>
            </div>
        </div>
    </div>

    <h1>PlaniPets Service</h1>

    <form method="POST" enctype="multipart/form-data">
        <div class="file-upload">
            <label for="file-input" class="file-label">📂 Choose CSV File</label>
            <input type="file" name="file" id="file-input" onchange="showFileNameAndButton()" />
            <div class="file-name" id="file-name" style="display: none;"></div>
            <input type="submit" value="Start" class="btn" id="import-btn" style="display: none;" />
        </div>
    </form>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Ville</th>
                <th>Quartier</th>
                <th>Metier</th>
                <th>Animal</th>
                <th>Specificite</th>
                <th>Prompts</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item['ville'] }}</td>
                <td>{{ item['quartier'] }}</td>
                <td>{{ item['metier'] }}</td>
                <td>{{ item['animal'] }}</td>
                <td>{{ item['specificite'] }}</td>
                <td>
                    <div class="prompt-dropdown-container">
                        <button class="btn prompt-btn" type="button"
                            onclick="showPromptOptions(event, {{ loop.index0 }})">default</button>
                        <select class="prompt-select" style="display: none;"
                            onchange="setPromptKey(this, {{ loop.index0 }})"></select>
                    </div>
                </td>
                <td>
                    <form method="POST" action="/item/{{ loop.index0 }}">
                        <input type="hidden" name="prompt_key" id="prompt-key-{{ loop.index0 }}" value="default">
                        <button class="btn" type="submit">Open</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No valid items found in the CSV.</p>
    {% endif %}

    <!-- Modal for Adding/Editing KV -->
    <div class="kv-modal" id="kvModal">
        <h4 id="kvModalTitle">Add/Edit Setting</h4>
        <label for="kvKey">Key:</label>
        <textarea id="kvKey" rows="3"></textarea>

        <label for="kvValue">Value:</label>
        <input type="text" id="kvValue" />

        <div class="kv-modal-buttons">
            <button class="btn" onclick="saveModalKV()">💾 Save</button>
            <button class="btn" onclick="closeModal()">❌ Cancel</button>
        </div>
    </div>

    <script>
        let selectedPromptKeys = {};
        let kvStore = {{ prompt_config | tojson }};
        let originalKVStore = JSON.parse(JSON.stringify(kvStore)); // Deep copy
        let selectedKey = null;

        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");
            const isVisible = panel.style.display === "block";

            if (!isVisible) {
                resetFormToOriginal();
                populateKeySelect();
                const keys = Object.keys(kvStore);
                if (keys.length > 0) {
                    loadKeyValue(keys[0]);
                } else {
                    addNewKey();
                }
            }

            panel.style.display = isVisible ? "none" : "block";
            overlay.style.display = isVisible ? "none" : "block";
        }

        function resetFormToOriginal() {
            kvStore = JSON.parse(JSON.stringify(originalKVStore));
            selectedKey = null;
            document.getElementById("saveBtn").disabled = true;
        }

        function populateKeySelect() {
            const select = document.getElementById("keySelect");
            select.innerHTML = "";
            Object.keys(kvStore).forEach(key => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }

        function onKeyChange() {
            const selected = document.getElementById("keySelect").value;
            loadKeyValue(selected);
        }

        function loadKeyValue(key) {
            selectedKey = key;
            document.getElementById("editKey").value = key;
            document.getElementById("editValue").value = kvStore[key];

            document.getElementById("editKey").oninput = checkChanges;
            document.getElementById("editValue").oninput = checkChanges;

            checkChanges();
        }

        function checkChanges() {
            const newKey = document.getElementById("editKey").value;
            const newValue = document.getElementById("editValue").value;

            const originalValue = originalKVStore[selectedKey];
            const changed = newKey !== selectedKey || newValue !== originalValue;

            document.getElementById("saveBtn").disabled = !changed;
        }

        function saveSelectedKV() {
            const newKey = document.getElementById("editKey").value.trim();
            const newValue = document.getElementById("editValue").value.trim();

            if (!newKey || !newValue) {
                alert("Both fields are required.");
                return;
            }

            // If adding new and key already exists
            if ((!selectedKey || newKey !== selectedKey) && kvStore.hasOwnProperty(newKey)) {
                alert("Key already exists.");
                return;
            }

            if (newKey !== selectedKey && selectedKey !== null) {
                delete kvStore[selectedKey];
            }

            kvStore[newKey] = newValue;

            fetch("/save-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kvStore)
            }).then(res => {
                if (res.ok) {
                    alert("Settings saved!");
                    originalKVStore = JSON.parse(JSON.stringify(kvStore));
                    populateKeySelect();
                    loadKeyValue(newKey);
                } else {
                    alert("Failed to save settings.");
                }
            });
        }

        function cancelSettings() {
            toggleSettings();
        }

        function addNewKey() {
            selectedKey = null;
            document.getElementById("editKey").value = "";
            document.getElementById("editValue").value = "";
            document.getElementById("saveBtn").disabled = false;
            document.getElementById("keySelect").selectedIndex = -1;
        }

        function deleteCurrentKey() {
            if (selectedKey && confirm(`Are you sure you want to delete "${selectedKey}"?`)) {
                delete kvStore[selectedKey];
                populateKeySelect();
                const firstKey = Object.keys(kvStore)[0];
                if (firstKey) {
                    loadKeyValue(firstKey);
                } else {
                    addNewKey();
                }
                document.getElementById("saveBtn").disabled = false;
            }
        }

        function renderKVList() {
            const kvList = document.getElementById("kv-list");
            kvList.innerHTML = "";

            Object.entries(kvStore).forEach(([key, value]) => {
                const div = document.createElement("div");
                div.className = "kv-item";
                div.innerHTML = `
                    <div class="kv-main">
                        <div><strong>${key}:</strong> ${value}</div>
                        <div class="kv-controls">
                            <button class="btn" onclick="editKV('${key}')">✏️ Edit</button>
                            <button class="btn" onclick="deleteKV('${key}')">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                kvList.appendChild(div);
            });
        }

        function onKeyChange() {
            const selected = document.getElementById("keySelect").value;
            loadKeyValue(selected);
        }

        function openModal(title, key = '', value = '', isEdit = false) {
            document.getElementById('kvModalTitle').textContent = title;
            document.getElementById('kvKey').value = key;
            document.getElementById('kvValue').value = value;
            document.getElementById('kvModal').style.display = 'block';
            editingKey = isEdit ? key : null;
        }

        function closeModal() {
            document.getElementById('kvModal').style.display = 'none';
            editingKey = null;
        }

        function addNewKV() {
            openModal('➕ Add New Setting');
        }

        function editKV(key) {
            openModal('✏️ Edit Setting', key, kvStore[key], true);
        }

        function saveModalKV() {
            const newKey = document.getElementById('kvKey').value.trim();
            const newValue = document.getElementById('kvValue').value.trim();

            if (!newKey || !newValue) {
                alert("Both fields are required.");
                return;
            }

            if (editingKey && newKey !== editingKey && kvStore.hasOwnProperty(newKey)) {
                alert("Key already exists.");
                return;
            }

            if (!editingKey && kvStore.hasOwnProperty(newKey)) {
                alert("Key already exists.");
                return;
            }

            if (editingKey && newKey !== editingKey) {
                delete kvStore[editingKey];
            }

            kvStore[newKey] = newValue;
            renderKVList();
            closeModal();
        }

        function deleteKV(key) {
            if (confirm("Are you sure you want to delete this item?")) {
                delete kvStore[key];
                renderKVList();
            }
        }

        function saveSettings() {
            fetch("/save-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kvStore)
            }).then(res => {
                if (res.ok) {
                    alert("Settings saved!");
                    toggleSettings();
                } else {
                    alert("Failed to save settings.");
                }
            });
        }

        function showFileNameAndButton() {
            const fileInput = document.getElementById("file-input");
            const fileName = document.getElementById("file-name");
            const importBtn = document.getElementById("import-btn");

            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
                fileName.style.display = "block";
                importBtn.style.display = "inline-block";
            } else {
                fileName.style.display = "none";
                importBtn.style.display = "none";
            }
        }

        function showPromptOptions(event, index) {
            const container = event.target.closest(".prompt-dropdown-container");
            const select = container.querySelector(".prompt-select");
            const button = container.querySelector(".prompt-btn");

            select.innerHTML = "";

            Object.keys(kvStore).forEach(key => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = key;
                if (selectedPromptKeys[index] === key) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            select.style.display = "inline-block";
            button.style.display = "none";
        }

        function setPromptKey(selectEl, index) {
            const selectedKey = selectEl.value;
            const container = selectEl.closest(".prompt-dropdown-container");
            const button = container.querySelector(".prompt-btn");

            button.textContent = selectedKey;
            button.style.display = "inline-block";
            selectEl.style.display = "none";

            selectedPromptKeys[index] = selectedKey;

            const hiddenInput = document.querySelector(`#prompt-key-${index}`);
            if (hiddenInput) {
                hiddenInput.value = selectedKey;
            }
        }
    </script>
</body>

</html>
