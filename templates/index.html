<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Gear2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <img src="https://planipets.com/images/logo.png" alt="">

    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <button class="settings-button btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>

    <div class="settings-panel" id="settingsPanel" style="display: none;">
        <h3>Settings</h3>

        <div style="display: flex; margin-top: 20px; gap: 20px;">
            <!-- Left: Key List -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <label><strong>Keys</strong></label>
                <ul id="keyList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px;"></ul>

                <!-- Buttons below the list -->
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="addNewKey()">‚ûï New Key</button>
                    <button class="btn" id="deleteBtn" onclick="deleteCurrentKey()" style="margin-left: 5px;">üóëÔ∏è Delete</button>
                </div>
            </div>

            <!-- Right: Edit Fields -->
            <div style="flex: 3;">
                <label><strong>Key Name</strong></label>
                <input type="text" id="editKey" style="width: 100%; margin-bottom: 10px;" />

                <label><strong>Value</strong></label>
                <textarea id="editValue" rows="6" style="width: 100%; height: 150px; resize: none;"></textarea>

                <!-- Save Button moved to right -->
                <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                    <button class="btn" id="saveBtn" onclick="saveSelectedKV()" disabled>üíæ Save</button>
                </div>
            </div>
        </div>

        <!-- Cancel Button at bottom right -->
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
            <button class="btn" onclick="cancelSettings()">‚ùå Cancel</button>
        </div>
    </div>

    <h1>PlaniPets Service</h1>

    <form method="POST" enctype="multipart/form-data">
        <div class="file-upload">
            <label for="file-input" class="file-label">üìÇ Choose CSV File</label>
            <input type="file" name="file" id="file-input" onchange="showFileNameAndButton()" />
            <div class="file-name" id="file-name" style="display: none;"></div>
            <input type="submit" value="Start" class="btn" id="import-btn" style="display: none;" />
        </div>
    </form>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Ville</th>
                <th>Quartier</th>
                <th>Metier</th>
                <th>Animal</th>
                <th>Specificite</th>
                <th>Prompts</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item['ville'] }}</td>
                <td>{{ item['quartier'] }}</td>
                <td>{{ item['metier'] }}</td>
                <td>{{ item['animal'] }}</td>
                <td>{{ item['specificite'] }}</td>
                <td>
                    <div class="prompt-dropdown-container">
                        <button class="btn prompt-btn" type="button" onclick="showPromptOptions(event, {{ loop.index0 }})">default</button>
                        <select class="prompt-select" style="display: none;" onchange="setPromptKey(this, {{ loop.index0 }})"></select>
                    </div>
                </td>
                <td>
                    <form method="POST" action="/item/{{ loop.index0 }}">
                        <input type="hidden" name="prompt_key" id="prompt-key-{{ loop.index0 }}" value="default">
                        <button class="btn" type="submit">Open</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No valid items found in the CSV.</p>
    {% endif %}

    <script>
        let selectedPromptKeys = {};
        let kvStore = {{ prompt_config | tojson }};
        let originalKVStore = JSON.parse(JSON.stringify(kvStore));
        let selectedKey = null;

        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");
            const isVisible = panel.style.display === "block";

            if (!isVisible) {
                resetFormToOriginal();
                populateKeyList();
                const keys = Object.keys(kvStore);
                if (keys.length > 0) {
                    loadKeyValue(keys[0]);
                }
            }

            panel.style.display = isVisible ? "none" : "block";
            overlay.style.display = isVisible ? "none" : "block";
        }

        function resetFormToOriginal() {
            kvStore = JSON.parse(JSON.stringify(originalKVStore));
            selectedKey = null;
            document.getElementById("saveBtn").disabled = true;
        }

        function populateKeyList() {
            const list = document.getElementById("keyList");
            list.innerHTML = "";

            Object.keys(kvStore).forEach(key => {
                const li = document.createElement("li");
                li.textContent = key;
                li.className = "key-item";
                li.onclick = () => loadKeyValue(key);
                li.onmouseenter = () => li.style.background = "#eee";
                li.onmouseleave = () => li.style.background = "";
                if (key === selectedKey) li.classList.add("active");
                list.appendChild(li);
            });

            const newLi = document.createElement("li");
            newLi.textContent = "‚ûï New Key";
            newLi.className = "key-item new-key";
            newLi.onclick = () => addNewKey();
            newLi.onmouseenter = () => newLi.style.background = "#eee";
            newLi.onmouseleave = () => newLi.style.background = "";
            list.appendChild(newLi);
        }

        function loadKeyValue(key) {
            selectedKey = key;
            const value = kvStore[key];
            document.getElementById("editKey").value = key;
            document.getElementById("editValue").value = value;
            document.getElementById("saveBtn").disabled = true;

            document.getElementById("editKey").oninput = checkChanges;
            document.getElementById("editValue").oninput = checkChanges;

            populateKeyList();
        }

        function checkChanges() {
            const newKey = document.getElementById("editKey").value;
            const newValue = document.getElementById("editValue").value;
            const originalValue = originalKVStore[selectedKey];
            const changed = newKey !== selectedKey || newValue !== originalValue;
            document.getElementById("saveBtn").disabled = !changed;
        }

        function saveSelectedKV() {
            const newKey = document.getElementById("editKey").value.trim();
            const newValue = document.getElementById("editValue").value.trim();

            if (!newKey || !newValue) {
                alert("Both fields are required.");
                return;
            }

            if ((!selectedKey || newKey !== selectedKey) && kvStore.hasOwnProperty(newKey)) {
                alert("Key already exists.");
                return;
            }

            if (newKey !== selectedKey && selectedKey !== null) {
                delete kvStore[selectedKey];
            }

            kvStore[newKey] = newValue;

            fetch("/save-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kvStore)
            }).then(res => {
                if (res.ok) {
                    alert("Settings saved!");
                    originalKVStore = JSON.parse(JSON.stringify(kvStore));
                    populateKeyList();
                    loadKeyValue(newKey);
                } else {
                    alert("Failed to save settings.");
                }
            });
        }

        function cancelSettings() {
            toggleSettings();
        }

        function addNewKey() {
            selectedKey = null;
            document.getElementById("editKey").value = "";
            document.getElementById("editValue").value = "";
            document.getElementById("saveBtn").disabled = false;
        }

        function deleteCurrentKey() {
            if (selectedKey && confirm(`Are you sure you want to delete "${selectedKey}"?`)) {
                delete kvStore[selectedKey];

                fetch("/save-config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(kvStore)
                }).then(res => {
                    if (res.ok) {
                        originalKVStore = JSON.parse(JSON.stringify(kvStore));
                        populateKeyList();
                        const firstKey = Object.keys(kvStore)[0];
                        if (firstKey) {
                            loadKeyValue(firstKey);
                        } else {
                            addNewKey();
                        }
                        document.getElementById("saveBtn").disabled = true;
                    } else {
                        alert("Failed to delete and save.");
                    }
                });
            }
        }

        function showFileNameAndButton() {
            const fileInput = document.getElementById("file-input");
            const fileName = document.getElementById("file-name");
            const importBtn = document.getElementById("import-btn");

            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
                fileName.style.display = "block";
                importBtn.style.display = "inline-block";
            } else {
                fileName.style.display = "none";
                importBtn.style.display = "none";
            }
        }

        function showPromptOptions(event, index) {
            const container = event.target.closest(".prompt-dropdown-container");
            const select = container.querySelector(".prompt-select");
            const button = container.querySelector(".prompt-btn");

            select.innerHTML = "";

            Object.keys(kvStore).forEach(key => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = key;
                if (selectedPromptKeys[index] === key) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            select.style.display = "inline-block";
            button.style.display = "none";
        }

        function setPromptKey(selectEl, index) {
            const selectedKey = selectEl.value;
            const container = selectEl.closest(".prompt-dropdown-container");
            const button = container.querySelector(".prompt-btn");

            button.textContent = selectedKey;
            button.style.display = "inline-block";
            selectEl.style.display = "none";

            selectedPromptKeys[index] = selectedKey;

            const hiddenInput = document.querySelector(`#prompt-key-${index}`);
            if (hiddenInput) {
                hiddenInput.value = selectedKey;
            }
        }
    </script>
</body>
</html>
