<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Gear2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <img src="https://planipets.com/images/logo.png" alt="">
</head>

<body>
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>

    <button class="settings-button btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>

    <div class="settings-panel" id="settingsPanel">
        <h3>Settings</h3>
        <div id="kv-list"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn" onclick="addNewKV()">‚ûï New</button>
            <button class="btn" onclick="saveSettings()">üíæ Save</button>
            <button class="btn" onclick="cancelSettings()">‚ùå Cancel</button>
        </div>
    </div>

    <h1>PlaniPets Service</h1>

    <form method="POST" enctype="multipart/form-data">
        <div class="file-upload">
            <label for="file-input" class="file-label">üìÇ Choose CSV File</label>
            <input type="file" name="file" id="file-input" onchange="showFileNameAndButton()" />
            <div class="file-name" id="file-name" style="display: none;"></div>
            <input type="submit" value="Start" class="btn" id="import-btn" style="display: none;" />
        </div>
    </form>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Ville</th>
                <th>Quartier</th>
                <th>Metier</th>
                <th>Animal</th>
                <th>Specificite</th>
                <th>Prompts</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item['ville'] }}</td>
                <td>{{ item['quartier'] }}</td>
                <td>{{ item['metier'] }}</td>
                <td>{{ item['animal'] }}</td>
                <td>{{ item['specificite'] }}</td>
                <td>
                    <div class="prompt-dropdown-container">
                        <button class="btn prompt-btn" type="button"
                            onclick="showPromptOptions(event, {{ loop.index0 }})">default</button>
                        <select class="prompt-select" style="display: none;"
                            onchange="setPromptKey(this, {{ loop.index0 }})"></select>
                    </div>
                </td>
                <td>
                    <form method="POST" action="/item/{{ loop.index0 }}">
                        <input type="hidden" name="prompt_key" id="prompt-key-{{ loop.index0 }}" value="default">
                        <button class="btn" type="submit">Open</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No valid items found in the CSV.</p>
    {% endif %}

    <script>
        let kvStore = {{ prompt_config | tojson }};
        let selectedPromptKeys = {};

        function renderKVList() {
            const kvList = document.getElementById("kv-list");
            kvList.innerHTML = "";

            Object.entries(kvStore).forEach(([key, value]) => {
                const div = document.createElement("div");
                div.className = "kv-item";
                div.innerHTML = `
                    <div class="kv-main">
                        <div><strong>${key}:</strong> ${value}</div>
                        <div class="kv-controls">
                            <button class="btn" onclick="editKV('${key}')">‚úèÔ∏è Edit</button>
                            <button class="btn" onclick="deleteKV('${key}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
                kvList.appendChild(div);
            });
        }

        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");
            const isVisible = panel.style.display === "block";

            panel.style.display = isVisible ? "none" : "block";
            overlay.style.display = isVisible ? "none" : "block";

            if (!isVisible) renderKVList();
        }

        function addNewKV() {
            const key = prompt("New Key:");
            const value = prompt("New Value:");
            if (!key || !value) return;
            if (kvStore.hasOwnProperty(key)) {
                alert("This key already exists.");
                return;
            }
            kvStore[key] = value;
            renderKVList();
        }

        function editKV(key) {
            const newKey = prompt("Edit Key:", key);
            const newValue = prompt("Edit Value:", kvStore[key]);
            if (!newKey || !newValue) return;
            if (newKey !== key && kvStore.hasOwnProperty(newKey)) {
                alert("Key already exists.");
                return;
            }
            delete kvStore[key];
            kvStore[newKey] = newValue;
            renderKVList();
        }

        function deleteKV(key) {
            if (confirm("Are you sure you want to delete this item?")) {
                delete kvStore[key];
                renderKVList();
            }
        }

        function saveSettings() {
            fetch("/save-config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kvStore)
            }).then(res => {
                if (res.ok) {
                    alert("Settings saved!");
                    toggleSettings();
                } else {
                    alert("Failed to save settings.");
                }
            });
        }

        function cancelSettings() {
            toggleSettings();
        }

        function showFileNameAndButton() {
            const fileInput = document.getElementById("file-input");
            const fileName = document.getElementById("file-name");
            const importBtn = document.getElementById("import-btn");

            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
                fileName.style.display = "block";
                importBtn.style.display = "inline-block";
            } else {
                fileName.style.display = "none";
                importBtn.style.display = "none";
            }
        }

        function showPromptOptions(event, index) {
            const container = event.target.closest(".prompt-dropdown-container");
            const select = container.querySelector(".prompt-select");
            const button = container.querySelector(".prompt-btn");

            select.innerHTML = "";

            Object.keys(kvStore).forEach(key => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = key;
                if (selectedPromptKeys[index] === key) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            select.style.display = "inline-block";
            button.style.display = "none";
        }

        function setPromptKey(selectEl, index) {
            const selectedKey = selectEl.value;
            const container = selectEl.closest(".prompt-dropdown-container");
            const button = container.querySelector(".prompt-btn");

            button.textContent = selectedKey;
            button.style.display = "inline-block";
            selectEl.style.display = "none";

            selectedPromptKeys[index] = selectedKey;

            const hiddenInput = document.querySelector(`#prompt-key-${index}`);
            if (hiddenInput) {
                hiddenInput.value = selectedKey;
            }
        }
    </script>
</body>

</html>
